<body>
    <div class="layout-wrapper layout-content-navbar">
        <div class="layout-container">
            <%- include('../../../partials/sideBar') %>
            <div class="layout-page">
                <%- include('../../../partials/header') %>
                <div class="content-wrapper">
                    <div class="admin-container">
                        <div class="admin-header">
                        <h2>Guest Details</h2>
                        <a href="/guest" class="btn btn-gradient">Back</a>
                        </div>

                        <div class="row">
                            <!-- Left Column - Profile Info -->
                            <div class="col-md-4">
                                <!-- Profile Card (same as before) -->

                                <div class="card shadow-sm mb-4">
                                    <!-- Background Image Section -->
                                    <div class="card-header p-0" style="height: 120px; overflow: hidden;">
                                        <% if (guest.backgroundImage) { %>
                                            <img src="<%= guest.backgroundImage %>" 
                                                class="img-fluid w-100 h-100 object-fit-cover"
                                                alt="Profile background" >
                                        <% } else { %>
                                            <div class="w-100 h-100" 
                                                style="background: linear-gradient(135deg, #6e8efb, #a777e3);">
                                            </div>
                                        <% } %>
                                    </div>
                                    
                                    <div class="card-body text-center" style="margin-top: -75px;">
                                        <!-- Profile Image Section -->
                                        <div class="position-relative" style="z-index: 1;">
                                            <% if (guest.profileImage) { %>
                                                <img src="<%= guest.profileImage %>" 
                                                    class="rounded-circle mb-3 border border-4 border-white shadow-sm"
                                                    width="150" height="150"
                                                    style="object-fit: cover;"
                                                    alt="Profile Image"
                                                    onerror="this.onerror=null;this.src='/temp/default-user.png'">
                                            <% } else { %>
                                                <div class="avatar-placeholder-lg rounded-circle mb-3 mx-auto border border-4 border-white shadow-sm"
                                                    style="width: 150px; height: 150px; background-color: #f8f9fa; display: flex; align-items: center; justify-content: center; font-size: 3rem; color: #495057;">
                                                    <%= guest.firstName?.charAt(0) %><%= guest.lastName?.charAt(0) %>
                                                </div>
                                            <% } %>
                                        </div>
                                        
                                        <h4 class="mt-2"><%= guest.firstName %> <%= guest.lastName %></h4>
                                        <p class="text-muted mb-1">
                                            <i class="fas fa-user-tag me-2"></i> Guest
                                        </p>
                                        <% if(adminPerms.includes('guest-status')) { %>
                                            <div class="d-flex justify-content-center gap-2 mt-3">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input status-toggle" 
                                                        type="checkbox" 
                                                        data-id="<%= guest._id %>"
                                                        <%= guest.isActive ? 'checked' : '' %>>
                                                    <label class="form-check-label">
                                                        <%= guest.isActive ? 'Active' : 'Blocked' %>
                                                    </label>
                                                </div>
                                            </div>
                                        <% } %>
                                    </div>
                                </div>

                                <div class="card shadow-sm mb-4">
                                    <div class="card-header bg-light d-flex justify-content-between">
                                        <h6 class="mb-0">Basic Information</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row mt-3">
                                            <div class="col-md-6">
                                                <p><strong>First Name:</strong> <%= guest.firstName %></p>
                                                <p><strong>Last Name:</strong> <%= guest.lastName %></p>
                                                <!-- <p><strong>Profile Status:</strong>
                                                    <span class="badge bg-<%= guest.profileCompletionStatus === 'complete' ? 'success' : 'warning' %>">
                                                        <%= guest.profileCompletionStatus === 'complete' ? 'Complete' : 'Incomplete' %>
                                                    </span>
                                                </p> -->
                                            </div>
                                            <div class="col-md-6">
                                                <p><strong>Roles:</strong>
                                                    <% guest.roles.forEach(role => { %>
                                                        <span class="badge bg-info me-1"> <%= role.charAt(0).toUpperCase() + role.slice(1) %></span>
                                                    <% }); %>
                                                </p>
                                                <p><strong>Active Role:</strong>
                                                    <span class="badge bg-primary"><%= guest.activeRole === 'host' ? 'Host' : 'Guest' %></span>
                                                </p>
                                            </div>
                                            <div class="col-md-12">
                                                <p><strong>Address:</strong> </p>
                                                 <% if (guest.address) { %>
                                                    <p><%= guest.address.street %></p>
                                                    <p><%= guest.address.city %>, <%= guest.address.state %></p>
                                                    <p>Postal Code: <%= guest.address.postalCode %></p>
                                                <% } else { %>
                                                    <p class="text-muted">No address information available</p>
                                                <% } %>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Contact Card -->
                                <div class="card shadow-sm">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Contact Information</h6>
                                    </div>
                                    <div class="card-body">
                                        <ul class="list-group list-group-flush">
                                            <li class="list-group-item px-0">
                                                <i class="fas fa-mobile-alt me-2 text-primary"></i>
                                                <%= guest.countryCode %> <%= guest.mobile || 'Not provided' %>
                                            </li>
                                            <li class="list-group-item px-0">
                                                <i class="fas fa-envelope me-2 text-primary"></i>
                                                <%= guest.email || 'Not provided' %>
                                            </li>
                                            <li class="list-group-item px-0">
                                                <i class="fas fa-calendar-alt me-2 text-primary"></i>
                                                Joined: <%= formatDate(guest.createdAt) %>
                                            </li>
                                            <li class="list-group-item px-0">
                                                <i class="fas fa-sign-in-alt me-2 text-primary"></i>
                                                Last Login: <%= formatDate(guest.lastLogin) || 'Never' %>
                                            </li>
                                        </ul>
                                    </div>
                                </div>

                            </div>

                            <!-- Right Column - Details -->
                            <div class="col-md-8">
                                <div class="card shadow-sm mb-4">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Quick Stats</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="stats-grid">
                                            <div class="stat-item">
                                                <div class="stat-icon bg-primary-light">
                                                <i class="fas fa-home text-primary"></i>
                                                </div>
                                                <div>
                                                    <h6 class="mb-0">Property Bookings</h6>
                                                    <p class="mb-0"><%= guestStats.totalPropertyBookings %></p>
                                                </div>
                                            </div>
                                            <div class="stat-item">
                                                <div class="stat-icon bg-success-light">
                                                <i class="fas fa-calendar-check text-success"></i>
                                                </div>
                                                <div>
                                                <h6 class="mb-0">Event Bookings</h6>
                                                <p class="mb-0"><%= guestStats.totalEventBookings %></p>
                                                </div>
                                            </div>
                                            <div class="stat-item">
                                                <div class="stat-icon bg-warning-light">
                                                <i class="fas fa-star text-warning"></i>
                                                </div>
                                                <div>
                                                <h6 class="mb-0">Property Reviews</h6>
                                                <p class="mb-0"><%= guestStats.totalPropertyRatings %></p>
                                                </div>
                                            </div>
                                            <div class="stat-item">
                                                <div class="stat-icon bg-info-light">
                                                    <i class="fas fa-star text-warning"></i>
                                                </div>
                                                <div>
                                                <h6 class="mb-0">Event Reviews</h6>
                                                <p class="mb-0"><%= guestStats.totalEventRatings %></p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card shadow-sm mb-4">
                                    <div class="card-header bg-light">
                                        <ul class="nav nav-tabs card-header-tabs" id="guestTabs" role="tablist">
                                            <% if(adminPerms.includes('guest-property-booking')) { %>
                                                <li class="nav-item">
                                                    <a class="nav-link active" id="property-bookings-tab" data-bs-toggle="tab" href="#property-bookings">Property Bookings</a>
                                                </li>
                                            <% } %>
                                            <% if(adminPerms.includes('guest-event-booking')) { %>
                                                <li class="nav-item">
                                                    <a class="nav-link" id="event-bookings-tab" data-bs-toggle="tab" href="#event-bookings">Event Bookings</a>
                                                </li>
                                            <% } %>
                                            <li class="nav-item">
                                                <a class="nav-link" id="property-reviews-tab" data-bs-toggle="tab" href="#property-reviews">Property Reviews</a>
                                            </li>
                                            <li class="nav-item">
                                                <a class="nav-link" id="event-reviews-tab" data-bs-toggle="tab" href="#event-reviews">Event Reviews</a>
                                            </li>
                                            <% if(adminPerms.includes('guest-payment-summary')) { %>
                                                <li class="nav-item">
                                                    <a class="nav-link" id="payment-summary-tab" data-bs-toggle="tab" href="#payment-summary">Payment Summary</a>
                                                </li>
                                            <% } %>
                                        </ul>
                                    </div>
                                    <div class="card-body">
                                        <div class="tab-content" id="guestTabsContent">
                                            <% if(adminPerms.includes('guest-property-booking')) { %>    
                                                <!-- Property Bookings Tab -->
                                                <div class="tab-pane fade show active" id="property-bookings" role="tabpanel">
                                                    <% if (propertyBookings.length > 0) { %>
                                                    <div class="table-responsive">
                                                        <table class="table table-hover" id="propertyBookingTable">
                                                            <thead>
                                                                <tr>
                                                                <th>Property</th>
                                                                <th>Booking ID</th>
                                                                <th>Dates</th>
                                                                <th>Amount</th>
                                                                <th>Status</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <% propertyBookings.forEach(booking => { %>
                                                                <tr>
                                                                    <td>
                                                                    <a href="/property/<%= booking.propertyId._id %>/show">
                                                                        <%= booking.propertyId.name %>
                                                                    </a>
                                                                    </td>
                                                                    <td><a href="/property/booking/<%= booking._id %>/show"><%= booking.bookingId %></a></td>
                                                                    <td>
                                                                        <%= formatDate(booking?.bookingDates?.startDate) %> - 
                                                                        <%= formatDate(booking?.bookingDates?.endDate) %>
                                                                    </td>
                                                                    <td><%= formatPrice(booking?.amountBreakdown?.finalAmount) %></td>
                                                                    <td>
                                                                    <span class="badge bg-<%= 
                                                                        booking.status === 'completed' ? 'success' : 
                                                                        booking.status === 'confirmed' ? 'info' : 
                                                                        booking.status === 'cancelled' ? 'danger' : 'warning' 
                                                                    %>">
                                                                        <%= booking.status.charAt(0).toUpperCase() + booking.status.slice(1) %>
                                                                    </span>
                                                                    </td>
                                                                </tr>
                                                                <% }); %>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    <% } else { %>
                                                    <div class="text-center py-4">
                                                        <i class="fas fa-home fa-3x text-muted mb-3"></i>
                                                        <h5>No Property Bookings</h5>
                                                        <p class="text-muted">This guest hasn't booked any properties yet.</p>
                                                    </div>
                                                    <% } %>
                                                </div>
                                            <% } %>

                                            <% if(adminPerms.includes('guest-event-booking')) { %>
                                                <!-- Event Bookings Tab -->
                                                <div class="tab-pane fade" id="event-bookings" role="tabpanel">
                                                    <% if (eventBookings.length > 0) { %>
                                                    <div class="table-responsive">
                                                        <table class="table table-hover" id="eventBookingTable">
                                                        <thead>
                                                            <tr>
                                                            <th>Event</th>
                                                            <th>Booking ID</th>
                                                            <th>Date</th>
                                                            <th>Amount</th>
                                                            <th>Status</th>
                                                            <th>Event Status</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <% eventBookings.forEach(booking => { %>
                                                            <tr>
                                                                <td>
                                                                <a href="/event/<%= booking.event._id %>/show">
                                                                    <%= booking.event.title %>
                                                                </a>
                                                                </td>
                                                                <td><%= booking.bookingId %></td>
                                                                <td><%= formatDate(booking.bookingDate) %></td>
                                                                <td><%= formatPrice(booking.paymentDetails.totalAmount) %></td>
                                                                <td>
                                                                <span class="badge bg-<%= 
                                                                    booking.status === 'completed' ? 'success' : 
                                                                    booking.status === 'confirmed' ? 'info' : 
                                                                    booking.status === 'cancelled' ? 'danger' : 'warning' 
                                                                %>">
                                                                    <%= booking.status.charAt(0).toUpperCase() + booking.status.slice(1) %>
                                                                </span>
                                                                </td>
                                                                <td>
                                                                <span class="badge bg-<%= 
                                                                    booking.event.status === 'completed' ? 'success' : 
                                                                    booking.event.status === 'upcoming' ? 'info' : 
                                                                    booking.event.status === 'cancelled' ? 'danger' : 'warning' 
                                                                %>">
                                                                    <%= booking.event.status.charAt(0).toUpperCase() + booking.event.status.slice(1) %>
                                                                </span>
                                                                </td>
                                                            </tr>
                                                            <% }); %>
                                                        </tbody>
                                                        </table>
                                                    </div>
                                                    <% } else { %>
                                                    <div class="text-center py-4">
                                                        <i class="fas fa-calendar-check fa-3x text-muted mb-3"></i>
                                                        <h5>No Event Bookings</h5>
                                                        <p class="text-muted">This guest hasn't booked any events yet.</p>
                                                    </div>
                                                    <% } %>
                                                </div>
                                            <% } %>

                                            <!-- Property Reviews Tab -->
                                            <div class="tab-pane fade" id="property-reviews" role="tabpanel">
                                                <% if (propertyRatings.length > 0) { %>
                                                <div class="review-list">
                                                    <% propertyRatings.forEach(review => { %>
                                                    <div class="review-item mb-4 pb-3 border-bottom">
                                                        <div class="d-flex justify-content-between mb-2">
                                                            <div>
                                                                <strong><%= review?.propertyId?.name %></strong>
                                                                <div class="star-rating mt-1 mb-2">
                                                                    <% for(let i = 1; i <= 5; i++) { %>
                                                                        <i class="fas fa-star <%= i <= review.rating ? 'text-warning' : 'text-muted' %>"></i>
                                                                    <% } %>
                                                                    <span class="ms-2 text-muted"><%= review.rating.toFixed(1) %></span>
                                                                </div>
                                                            </div>
                                                            <small class="text-muted"><%= formatDate(review.createdAt) %></small>
                                                        </div>
                                                        
                                                        <!-- Category Ratings -->
                                                        <div class="category-ratings mb-3">
                                                            <div class="row g-2">
                                                                <div class="col-md-4">
                                                                    <div class="d-flex align-items-center">
                                                                        <small class="text-muted me-2">Comfort:</small>
                                                                        <div class="star-rating small">
                                                                            <% for(let i = 1; i <= 5; i++) { %>
                                                                                <i class="fas fa-star <%= i <= review.comfortableRating ? 'text-info' : 'text-muted' %>"></i>
                                                                            <% } %>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-4">
                                                                    <div class="d-flex align-items-center">
                                                                        <small class="text-muted me-2">Cleanliness:</small>
                                                                        <div class="star-rating small">
                                                                            <% for(let i = 1; i <= 5; i++) { %>
                                                                                <i class="fas fa-star <%= i <= review.cleanlinessRating ? 'text-success' : 'text-muted' %>"></i>
                                                                            <% } %>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-4">
                                                                    <div class="d-flex align-items-center">
                                                                        <small class="text-muted me-2">Facilities:</small>
                                                                        <div class="star-rating small">
                                                                            <% for(let i = 1; i <= 5; i++) { %>
                                                                                <i class="fas fa-star <%= i <= review.facilitiesRating ? 'text-primary' : 'text-muted' %>"></i>
                                                                            <% } %>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        <% if (review.review) { %>
                                                            <p class="mb-2"><%= review.review %></p>
                                                        <% } %>
                                                    </div>
                                                    <% }); %>
                                                </div>
                                                <% } else { %>
                                                <div class="text-center py-4">
                                                    <i class="fas fa-star fa-3x text-muted mb-3"></i>
                                                    <h5>No Property Reviews</h5>
                                                    <p class="text-muted">This guest hasn't reviewed any properties yet.</p>
                                                </div>
                                                <% } %>
                                            </div>

                                            <!-- Event Reviews Tab -->
                                            <div class="tab-pane fade" id="event-reviews" role="tabpanel">
                                                <% if (eventRatings.length > 0) { %>
                                                <div class="review-list">
                                                    <% eventRatings.forEach(review => { %>
                                                    <div class="review-item mb-4 pb-3 border-bottom">
                                                        <div class="d-flex justify-content-between mb-2">
                                                        <div>
                                                            <strong><%= review.eventId.title %></strong>
                                                            <div class="star-rating mt-1">
                                                            <% for(let i = 1; i <= 5; i++) { %>
                                                                <i class="fas fa-star <%= i <= review.rating ? 'text-warning' : 'text-muted' %>"></i>
                                                            <% } %>
                                                            </div>
                                                        </div>
                                                        <small class="text-muted"><%= formatDate(review.createdAt) %></small>
                                                        </div>
                                                        <p class="mb-2"><%= review.review %></p>
                                                    </div>
                                                    <% }); %>
                                                </div>
                                                <% } else { %>
                                                <div class="text-center py-4">
                                                    <i class="fas fa-star fa-3x text-muted mb-3"></i>
                                                    <h5>No Event Reviews</h5>
                                                    <p class="text-muted">This guest hasn't reviewed any events yet.</p>
                                                </div>
                                                <% } %>
                                            </div>

                                            <!-- Payment Summary Tab -->
                                            <div class="tab-pane fade" id="payment-summary" role="tabpanel">

                                                <!-- Wallet Summary Card -->
                                                <div class="card mb-4" style="border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); border: none;">
                                                    <div class="card-header text-white" style="background: linear-gradient(135deg, #46cfc3, #2471b7); border-radius: 12px 12px 0 0;">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div>
                                                        <h4 class="mb-1 text-white">Wallet Balance</h4>
                                                        <p class="mb-0">Available for withdrawal</p>
                                                        </div>
                                                        <i class="fas fa-wallet fa-2x opacity-75"></i>
                                                    </div>
                                                    </div>
                                                    <div class="card-body mt-4">
                                                    <div class="row">
                                                        <div class="col-md-6 mb-3 mb-md-0">
                                                        <div class="d-flex align-items-center">
                                                            <div class="me-3">
                                                            <p class="text-muted mb-0">Withdrawal Balance</p>
                                                            <h2 id="wallet-balance" class="text-primary mb-0" style="font-size: 2.5rem; font-weight: 700;">₹0.00</h2>
                                                            </div>
                                                        </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                        <div class="d-flex align-items-center">
                                                            <div class="me-3">
                                                            <p class="text-muted mb-0">Total Withdraw Amount</p>
                                                            <h2 id="wallet-total" class="text-success mb-0" style="font-size: 2.5rem; font-weight: 700;">₹0.00</h2>
                                                            </div>
                                                        </div>
                                                        </div>
                                                    </div>
                                                    </div>
                                                </div>

                                                <!-- Transaction List -->
                                                <div class="card" style="border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); border: none;">
                                                    <div class="card-body">
                                                        <div class="d-flex justify-content-between align-items-center mb-4">
                                                            <h5 class="mb-0">Transaction History</h5>
                                                        </div>
                                                        <!-- Transaction List -->
                                                        <div id="transaction-list" class="transaction-list"></div>

                                                        <!-- Pagination -->
                                                        <nav aria-label="Transaction pagination" class="mt-4">
                                                            <ul id="pagination" class="pagination justify-content-center"></ul>
                                                        </nav>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="layout-overlay layout-menu-toggle"></div>
    </div> 
</body>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
    let currentPage = 1;
    const userId = "<%= guest._id %>";
    const role = "guest";
    const limit = 10; 

    async function loadWallet(page = 1) {
        try {
        const res = await axios.get(`/api/v1/common/getWalletDetails`, {
            params: { userId, role, page, limit }
        });

        if (res.data.status) {
            const wallet = res.data.data.wallet;
            const txData = res.data.data.transactions;
            const pagination = res.data.data.pagination;

            // --- Wallet Balance
            document.getElementById("wallet-balance").textContent = `${formatPrice(wallet.balance)}`;
            document.getElementById("wallet-total").textContent =  `${formatPrice(wallet.totalEarnings || 0)}`;

            // --- Transactions render
            const list = document.getElementById("transaction-list");
            list.innerHTML = "";

            txData.forEach(tx => {
            let badgeClass = "bg-secondary", icon = "fas fa-money-bill", label = "Transaction", amountColor = "text-dark";

            if (tx.transactionType === "property_booking") {
                badgeClass = "bg-success"; icon = "fas fa-home"; label = "Property"; amountColor = "text-danger";
            } else if (tx.transactionType === "event_booking") {
                badgeClass = "bg-primary"; icon = "fas fa-calendar-alt"; label = "Event"; amountColor = "text-danger";
            } else if (tx.transactionType === "refund") {
                badgeClass = "bg-danger"; icon = "fas fa-undo-alt"; label = "Refund"; amountColor = "text-success";
            } else if (tx.transactionType === "withdrawal") {
                badgeClass = "bg-warning"; icon = "fas fa-download"; label = "Withdrawal"; amountColor = "text-success";
            }

            const amountSign = (tx.transactionType === "withdrawal" || tx.transactionType === "refund") ? "+" : "-";
            const amount = `${amountSign}${formatPrice(tx.amount)}`;
            const date = `${formatDate(tx.createdAt)}`;

            // Use bookingDetails._id if available, otherwise fallback to tx._id
            const refId = `• Ref #${tx.bookingDetails?.bookingId ||''}`;

            const html = `
                <div class="card mb-3" style="border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: none;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <div class="${badgeClass} text-white me-3"
                        style="width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px;">
                        <i class="${icon}"></i>
                        </div>
                        <div>
                        <h6 class="mb-0">${label} ${tx.status === "completed" ? "" : `(${tx.status})`}</h6>
                        <p class="text-muted mb-0">${date} ${refId}</p>
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold ${amountColor}" style="font-size: 1.1rem;">${amount}</div>
                        <span class="badge ${badgeClass}">${label}</span>
                    </div>
                    </div>
                </div>
                </div>
            `;
            list.insertAdjacentHTML("beforeend", html);
            });

            // --- Render pagination
            renderPagination(pagination.page, pagination.pages);
        }
        } catch (err) {
        console.error("Wallet fetch failed:", err);
        }
    }

    function renderPagination(current, totalPages) {
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";

        const delta = 2; // current page ke left/right buttons count
        let range = [];
        let l;

        // calculate visible pages
        for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= current - delta && i <= current + delta)) {
            range.push(i);
        }
        }

        // add Prev button
        pagination.insertAdjacentHTML("beforeend", `
        <li class="page-item ${current === 1 ? "disabled" : ""}">
            <a class="page-link" href="#" data-page="${current - 1}">Previous</a>
        </li>
        `);

        // add page buttons with ellipsis
        for (let i of range) {
        if (l) {
            if (i - l !== 1) {
            pagination.insertAdjacentHTML("beforeend", `
                <li class="page-item disabled"><span class="page-link">…</span></li>
            `);
            }
        }
        pagination.insertAdjacentHTML("beforeend", `
            <li class="page-item ${i === current ? "active" : ""}">
            <a class="page-link" href="#" data-page="${i}">${i}</a>
            </li>
        `);
        l = i;
        }

        // add Next button
        pagination.insertAdjacentHTML("beforeend", `
        <li class="page-item ${current === totalPages ? "disabled" : ""}">
            <a class="page-link" href="#" data-page="${current + 1}">Next</a>
        </li>
        `);

        // Click listeners
        pagination.querySelectorAll("a.page-link").forEach(el => {
        el.addEventListener("click", e => {
            e.preventDefault();
            const page = parseInt(e.target.dataset.page);
            if (!isNaN(page) && page >= 1 && page <= totalPages) {
            currentPage = page;
            loadWallet(currentPage);
            }
        });
        });
    }

    // First load
    loadWallet(currentPage);
    });
</script>


<style>
    /* Custom styles for the guest details page */
    .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }
    
    .stat-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem;
        border-radius: 0.5rem;
        background-color: #f8f9fa;
    }
    
    .stat-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
    }
    
    .bg-primary-light { background-color: rgba(13, 110, 253, 0.1); }
    .bg-success-light { background-color: rgba(25, 135, 84, 0.1); }
    .bg-warning-light { background-color: rgba(255, 193, 7, 0.1); }
    .bg-info-light { background-color: rgba(13, 202, 240, 0.1); }
    
    .nav-tabs .nav-link {
        border: none;
        color: #6c757d;
        font-weight: 500;
        padding: 0.75rem 1.25rem;
    }
    
    .nav-tabs .nav-link.active {
        color: #0d6efd;
        border-bottom: 3px solid #0d6efd;
        background-color: transparent;
    }
    
    .review-item {
        padding-bottom: 1rem;
    }
    
    .host-reply {
        border-left: 3px solid #0d6efd;
    }
    
    .star-rating {
        color: #ffc107;
    }
</style>

<script>
    $(document).ready(function() {
        $('#propertyBookingTable').DataTable();
        $('#eventBookingTable').DataTable();
    });
</script>

<script>
    // Status toggle handler for detail page
    $('.status-toggle').change(function() {
        const guestId = $(this).data('id');
        const isActive = $(this).is(':checked');
        
        $.ajax({
            url: `/guest/${guestId}/status`,
            method: 'PUT',
            data: { isActive },
            success: function(response) {
                if (response.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: response.message,
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => {
                        location.reload();
                    });
                }
            },
            error: function(xhr) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: xhr.responseJSON?.message || 'Failed to update status'
                });
                $(this).prop('checked', !isActive);
            }
        });
    });

    // Initialize Bootstrap tabs
    var tabEl = document.querySelectorAll('a[data-bs-toggle="tab"]');
    tabEl.forEach(function(tab) {
        tab.addEventListener('shown.bs.tab', function (event) {
            localStorage.setItem('lastTab', event.target.id);
        });
    });

    // Activate last active tab if available
    var lastTab = localStorage.getItem('lastTab');
    if (lastTab) {
        var tab = new bootstrap.Tab(document.querySelector('#' + lastTab));
        tab.show();
    }
</script>