<body>
    <div class="layout-wrapper layout-content-navbar">
        <div class="layout-container">
            <%- include('../../../../partials/sideBar') %>
            <div class="layout-page">
                <%- include('../../../../partials/header') %>
                <div class="content-wrapper">
                    <div class="admin-container">
                        <div class="admin-header">
                            <h2>FAQ's</h2>
                        </div>

                        <div class="row g-4 mb-4">
                            <div class="col-md-12 col-lg-12">
                                <% if(adminPerms.includes('faqs-create')) { %>
                                    <div class="card mb-4">
                                        <h5 class="card-header">Add New FAQ</h5>
                                        <div class="card-body">
                                            <form id="faqForm">
                                                <div class="row">
                                                    <div class="mb-3 col-md-12">
                                                        <label for="question" class="form-label">Question</label>
                                                        <input class="form-control" type="text" id="question" name="question" required>
                                                    </div>
                                                </div>

                                                <div class="mb-3">
                                                    <label for="answer" class="form-label">Answer</label>
                                                    <textarea class="form-control" id="answer" name="answer" rows="3" required></textarea>
                                                </div>

                                                <div class="row">
                                                    <div class="mb-3 col-md-3">
                                                        <label for="order" class="form-label">Display Order</label>
                                                        <input class="form-control" type="number" id="order" name="order" value="0">
                                                    </div>
                                                    <div class="mb-3 col-md-3 d-flex align-items-end">
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox" id="isActive" name="isActive" checked>
                                                            <label class="form-check-label" for="isActive">Active</label>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="mt-4">
                                                    <button type="submit" class="btn btn-primary me-2" id="saveFaqBtn">
                                                        <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                                                        <span id="submitBtnText">Add FAQ</span>
                                                    </button>
                                                    <button type="reset" class="btn btn-outline-secondary d-none" id="cancelEditBtn">Cancel</button>
                                                    <input type="hidden" id="faqId" name="id" value="">
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                <% } %>

                                <div class="card">
                                    <h5 class="card-header">FAQ List</h5>
                                    <div class="card-body">
                                        <div class="">
                                            <table class="table table-hover" id="faqTable">
                                                <thead>
                                                    <tr>
                                                        <th>S.NO</th>
                                                        <th>Question</th>
                                                        <th>Answer</th>
                                                        <th>Status</th>
                                                        <th>Order</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <% faqs.forEach((faq, loopIndex) => { %>
                                                        <tr data-id="<%= faq._id %>">
                                                            <td><%= loopIndex + 1 %></td>
                                                            <td><%= faq.question %></td>
                                                            <td><%= faq.answer %></td>
                                                            <td>
                                                                <span class="badge bg-<%= faq.isActive ? 'success' : 'danger' %>">
                                                                    <%= faq.isActive ? 'Active' : 'Inactive' %>
                                                                </span>
                                                            </td>
                                                            <td><%= faq.order %></td>
                                                            <td>
                                                                <% if(adminPerms.includes('faqs-edit')) { %>
                                                                    <button class="btn btn-sm btn-icon btn-outline-primary edit-faq" data-id="<%= faq._id %>">
                                                                        <i class="bx bx-edit"></i>
                                                                    </button>
                                                                <% } %>
                                                               <% if(adminPerms.includes('faqs-delete')) { %>
                                                                    <button class="btn btn-sm btn-icon btn-outline-danger delete-faq" data-id="<%= faq._id %>">
                                                                        <i class="bx bx-trash"></i>
                                                                    </button>
                                                                <% } %>
                                                            </td>
                                                        </tr>
                                                    <% }); %>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <%- include('../../../../partials/footer') %>
                    <div class="content-backdrop fade"></div>
                </div>
            </div>
        </div>
        <div class="layout-overlay layout-menu-toggle"></div>
    </div>
</body> 

<script>
$(document).ready(function() {

    // FAQ form submission
    $('#faqForm').on('submit', function(e) {
        e.preventDefault();
        const btn = $('#saveFaqBtn');
        btn.prop('disabled', true);
        btn.find('.spinner-border').removeClass('d-none');

        const faqId = $('#faqId').val();
        const url = faqId ? `/faqs/${faqId}` : '/faqs';
        const method = faqId ? 'PUT' : 'POST';

        $.ajax({
            url: url,
            method: method,
            data: $(this).serialize(),
            success: function(response) {

                Swal.fire({
                    title: 'Success!',
                    text: `FAQ ${faqId ? 'updated' : 'created'} successfully`,
                    icon: 'success',
                    confirmButtonText: 'OK'
                }).then(() => {
                    // Reload the page to see changes
                    window.location.reload();
                });
                if (faqId) {
                    // Update existing row
                    const row = $(`#faqTable tbody tr[data-id="${faqId}"]`);
                    row.find('td:eq(0)').text(loopIndex + 1);
                    row.find('td:eq(1)').text(response.faq.question);
                    row.find('td:eq(2)').text(response.faq.answer);
                    row.find('td:eq(3)').html(`
                        <span class="badge bg-${response.faq.isActive ? 'success' : 'danger'}">
                            ${response.faq.isActive ? 'Active' : 'Inactive'}
                        </span>
                    `);
                    row.find('td:eq(4)').text(response.faq.order);
                } else {
                    $('#faqTable tbody').append(`
                        <tr data-id="${response.faq._id}">
                            <td>${response.faq.question}</td>
                            <td>
                                <span class="badge bg-${response.faq.isActive ? 'success' : 'danger'}">
                                    ${response.faq.isActive ? 'Active' : 'Inactive'}
                                </span>
                            </td>
                            <td>${response.faq.order}</td>
                            <td>
                                <button class="btn btn-sm btn-icon btn-outline-primary edit-faq" data-id="${response.faq._id}">
                                    <i class="bx bx-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-icon btn-outline-danger delete-faq" data-id="${response.faq._id}">
                                    <i class="bx bx-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `);
                }
                $('#faqForm').trigger('reset');
                $('#faqId').val('');
                $('#submitBtnText').text('Add FAQ');
                $('#cancelEditBtn').addClass('d-none');
            },
            error: function(xhr) {
                console.error(xhr.responseText);
                Swal.fire({
                    title: 'Error!',
                    text: xhr.responseText || 'Failed to create FAQ',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            },
            complete: function() {
                btn.prop('disabled', false);
                btn.find('.spinner-border').addClass('d-none');
            }
        });
    });

    // Edit FAQ
    $(document).on('click', '.edit-faq', function() {
        const faqId = $(this).data('id');
        const row = $(this).closest('tr');
        
        $('#faqForm #question').val(row.find('td:eq(1)').text());
        $('#faqForm #answer').val(row.find('td:eq(2)').text()); 
        $('#faqForm #order').val(row.find('td:eq(4)').text());
        $('#faqForm #isActive').prop('checked', row.find('td:eq(3)').find('.badge').hasClass('bg-success'));
        $('#faqId').val(faqId);
        $('#submitBtnText').text('Update FAQ');
        $('#cancelEditBtn').removeClass('d-none');
        
        // Scroll to form
        $('html, body').animate({
            scrollTop: $('#faqForm').offset().top - 20
        }, 300);
    });

    // Cancel edit
    $('#cancelEditBtn').on('click', function() {
        $('#faqForm').trigger('reset');
        $('#faqId').val('');
        $('#submitBtnText').text('Add FAQ');
        $(this).addClass('d-none');
    });

    // Delete FAQ
    $(document).on('click', '.delete-faq', function() {
        const faqId = $(this).data('id');
        
        Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: `/faqs/${faqId}`,
                    method: 'DELETE',
                    success: function() {
                        Swal.fire({
                            title: 'Success!',
                            text: 'FAQ deleted successfully',
                            icon: 'success',
                            confirmButtonText: 'OK'
                        }).then(() => {
                           location.reload();
                        });
                    },
                    error: function(xhr) {
                        Swal.fire({
                            title: 'Error!',
                            text: xhr.responseJSON?.message || 'Failed to delete FAQ',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    }
                });
            }
        });
    });
});
</script>

