<body>
    <style>
        .slider-item {
            position: relative;
            transition: all 0.3s ease;
        }

        .slider-item:hover {
             background-color: #f8f9fa;
        }
        .slider-preview {
            max-width: 100%;
            height: auto;
            object-fit: cover;
        }
    </style>
    <div class="layout-wrapper layout-content-navbar">
        <div class="layout-container">
            <%- include('../../../../partials/sideBar') %>
            <div class="layout-page">
                <%- include('../../../../partials/header') %>
                <div class="content-wrapper">
                    <div class="admin-container">
                        <div class="admin-header">
                            <h2><%= title %></h2>
                        </div>

                        <!-- <div class="row g-4 mb-4">
                            <div class="col-md-12 col-lg-12">
                                <div class="card">
                                    <div class="card-header">
                                            <h5>Page info</h5>
                                    </div>
                                    <div class="card-body">
                                        <form id="pageForm" enctype="multipart/form-data">
                                            <input type="hidden" name="pageType" value="<%= page?.pageType || '' %>">
                                            <input type="hidden" name="removeBannerImage" id="removeBannerImageFlag" value="false">
                                            
                                            <div class="row">
                                                <div class="mb-3 col-md-6">
                                                    <label class="form-label">Title</label>
                                                    <input type="text" class="form-control" name="title" value="<%= page?.title || '' %>" required>
                                                </div>
                                                <div class="mb-3 col-md-6">
                                                    <label class="form-label">Subtitle</label>
                                                    <input type="text" class="form-control" name="subtitle" value="<%= page?.subtitle || '' %>">
                                                </div>
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label">Content</label>
                                                <textarea class="form-control" name="content" rows="5"><%= page?.content || '' %></textarea>
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label">Banner Image</label>
                                                <input type="file" class="form-control" name="bannerImage" id="bannerImage">
                                                <% if (page?.bannerImage) { %>
                                                    <div class="mt-2" id="bannerImageContainer">
                                                        <img src="<%= page.bannerImage %>" style="max-height: 150px;" class="img-thumbnail" id="bannerImagePreview">
                                                        <button type="button" class="btn btn-sm btn-outline-danger mt-2" id="removeBannerImageBtn">
                                                            <i class="bx bx-trash"></i> Remove
                                                        </button>
                                                    </div>
                                                <% } else { %>
                                                    <div class="mt-2" id="bannerImageContainer" style="display: none;">
                                                        <img src="" style="max-height: 150px;" class="img-thumbnail" id="bannerImagePreview">
                                                        <button type="button" class="btn btn-sm btn-outline-danger mt-2" id="removeBannerImageBtn">
                                                            <i class="bx bx-trash"></i> Remove
                                                        </button>
                                                    </div>
                                                <% } %>
                                            </div>

                                            <div class="mt-4">
                                                <button type="submit" class="btn btn-primary me-2" id="savePageBtn">
                                                    <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                                                    Save Changes
                                                </button>
                                                <button type="reset" class="btn btn-outline-secondary">Reset</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div> -->

                        <div class="row g-4 mb-4">
                            <div class="col-md-12 col-lg-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>Slider Management</h5>
                                    </div>
                                    <div class="card-body">
                                        <!-- Existing Sliders -->
                                        <% (page.sliderImages || []).forEach((slider, index) => { %>
                                        <div class="slider-form-container mb-9 border p-3">
                                            <form class="slider-form" enctype="multipart/form-data">
                                                <input type="hidden" name="pageType" value="<%= page.pageType %>">
                                                <input type="hidden" name="sliderId" value="<%= index %>">
                                                <input type="hidden" name="action" value="update">

                                                <div class="row">
                                                    <div class="mb-3 col-md-6">
                                                        <label class="form-label">Title</label>
                                                        <input type="text" class="form-control" name="title" value="<%= slider.title %>">
                                                    </div>
                                                    <div class="mb-3 col-md-6">
                                                        <label class="form-label">Subtitle</label>
                                                        <input type="text" class="form-control" name="subtitle" value="<%= slider.subtitle %>">
                                                    </div>
                                                </div>

                                                <div class="mb-3">
                                                    <label class="form-label">Content</label>
                                                    <textarea class="form-control" name="content" rows="3"><%= slider.content %></textarea>
                                                </div>

                                                <div class="mb-3">
                                                    <label class="form-label">Image</label>
                                                    <input type="file" class="form-control slider-image" name="sliderImage">
                                                    <% if(slider.image) { %>
                                                        <img src="<%= slider.image %>" class="img-thumbnail mt-2 slider-preview" style="max-height: 150px;">
                                                    <% } else { %>
                                                        <img src="" class="img-thumbnail mt-2 slider-preview" style="max-height: 150px; display: none;">
                                                    <% } %>
                                                </div>

                                                <div class=" mt-2">
                                                    <button type="button" class="btn btn-danger remove-slider-btn">
                                                        <i class="bx bx-trash"></i>
                                                    </button>
                                                </div>
                                                
                                                <div class=" mt-2">
                                                    <button type="submit" class="btn btn-primary">
                                                        <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                                                        Update Slider
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                        <% }); %>

                                        <!-- Add New Slider Form -->
                                        <div class="slider-form-container mb-4 border p-3">
                                            <form class="slider-form" id="addSliderForm" enctype="multipart/form-data">
                                                <input type="hidden" name="pageType" value="<%= page.pageType %>">
                                                <input type="hidden" name="action" value="add">
                                                    <div class="row">
                                                        <div class="mb-3 col-md-6">
                                                            <label class="form-label">Title</label>
                                                            <input type="text" class="form-control" name="title" required>
                                                        </div>
                                                        <div class="mb-3 col-md-6">
                                                            <label class="form-label">Subtitle</label>
                                                            <input type="text" class="form-control" name="subtitle">
                                                        </div>
                                                    </div>

                                                    <div class="mb-3">
                                                        <label class="form-label">Content</label>
                                                        <textarea class="form-control" name="content" rows="3"></textarea>
                                                    </div>

                                                    <div class="mb-3">
                                                        <label class="form-label">Image</label>
                                                        <input type="file" class="form-control slider-image" name="sliderImage" required>
                                                        <img src="" class="img-thumbnail mt-2 slider-preview" style="max-height: 150px; display: none;">
                                                    </div>
                    
                                            
                                                <div class="mt-2">
                                                    <button type="submit" class="btn btn-success">
                                                        <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                                                        Add Slider
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>   

                        <% if(page.pageType == "home") { %>

                            <!-- Property Type Section -->
                            <div class="row g-4 mb-4 mt-4">
                                <div class="col-md-12 col-lg-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5>Property Type Section<small>(Min and Max 6)</small></h5>
                                        </div>
                                        <div class="card-body">
                                            <form id="propertyTypeForm">
                                                <input type="hidden" name="pageType" value="<%= page?.pageType || '' %>">

                                                <div class="row">
                                                    <div class="mb-3 col-md-12">
                                                        <label class="form-label">Section Title</label>
                                                        <input type="text" class="form-control" name="propertyTypesTitle" 
                                                            value="<%= page?.selectedItems?.propertyTypes?.title || '' %>" required>
                                                    </div>
                                                </div>

                                                <div class="row">
                                                    <div class="mb-1 col-md-12">
                                                        <table class="table table-border">
                                                            <tbody>
                                                                <% if(propertyTypes.length > 0){ %>
                                                                    <% propertyTypes.forEach(type => {  %>
                                                                        <tr>
                                                                        <td>
                                                                            <input type="checkbox" name="propertyTypes" 
                                                                                value="<%= type._id %>" 
                                                                                <%= type.isSelected ? 'checked' : '' %>>
                                                                        </td>
                                                                        <td><%= type.name %></td>
                                                                        <td><img src="<%= type.image %>" alt="<%= type.name %>" style="max-height: 50px;"></td>
                                                                        </tr>
                                                                    <% }); %>
                                                                <% } else { %>
                                                                    <tr>
                                                                        <td colspan="3">No property types available</td>
                                                                    </tr>
                                                                <% } %>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                                
                                                <div class="mt-4">
                                                    <button type="submit" class="btn btn-primary me-2" id="savePropertyTypeBtn">
                                                        <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                                                        Save Changes
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Services Section -->
                            <div class="row g-4 mb-4 mt-4">
                                <div class="col-md-12 col-lg-12">
                                <div class="card">
                                    <div class="card-header">
                                    <h5>Services Section <small>(Min and Max 6)</small></h5>
                                    </div>
                                    <div class="card-body">
                                    <form id="servicesForm">
                                        <input type="hidden" name="pageType" value="<%= page?.pageType || '' %>">

                                        <div class="row">
                                        <div class="mb-3 col-md-12">
                                            <label class="form-label">Section Title</label>
                                            <input type="text" class="form-control" name="servicesTitle" 
                                                value="<%= page?.selectedItems?.services?.title || '' %>" required>
                                        </div>
                                        </div>

                                        <div class="row">
                                        <div class="mb-1 col-md-12">
                                            <table class="table table-border">
                                            <tbody>
                                                <% if(services.length > 0){ %>
                                                <% services.forEach(service => {  %>
                                                    <tr>
                                                    <td>
                                                        <input type="checkbox" name="services" 
                                                            value="<%= service._id %>" 
                                                            <%= service.isSelected ? 'checked' : '' %>>
                                                    </td>
                                                    <td><%= service.name %></td>
                                                    <td><img src="<%= service.image %>" alt="<%= service.name %>" style="max-height: 50px;"></td>
                                                    </tr>
                                                <% }); %>
                                                <% } else { %>
                                                <tr>
                                                    <td colspan="3">No services available</td>
                                                </tr>
                                                <% } %>
                                            </tbody>
                                            </table>
                                        </div>
                                        </div>
                                        
                                        <div class="mt-4">
                                        <button type="submit" class="btn btn-primary me-2" id="saveServicesBtn">
                                            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                                            Save Changes
                                        </button>
                                        </div>
                                    </form>
                                    </div>
                                </div>
                                </div>
                            </div>

                            <!-- Events Section -->
                            <div class="row g-4 mb-4">
                                <div class="col-md-12 col-lg-12">
                                <div class="card">
                                    <div class="card-header">
                                    <h5>Event Categories Section <small>(Min and Max 6)</small></h5>
                                    </div>
                                    <div class="card-body">
                                    <form id="eventsForm">
                                        <input type="hidden" name="pageType" value="<%= page?.pageType || '' %>">

                                        <div class="row">
                                        <div class="mb-3 col-md-12">
                                            <label class="form-label">Section Title</label>
                                            <input type="text" class="form-control" name="eventsTitle" 
                                                value="<%= page?.selectedItems?.events?.title || '' %>" required>
                                        </div>
                                        </div>

                                        <div class="row">
                                        <div class="mb-1 col-md-12">
                                            <table class="table table-border">
                                            <tbody>
                                                <% if(events.length > 0){ %>
                                                <% events.forEach(event => {  %>
                                                    <tr>
                                                    <td>
                                                        <input type="checkbox" name="events" 
                                                            value="<%= event._id %>" 
                                                            <%= event.isSelected ? 'checked' : '' %>>
                                                    </td>
                                                    <td><%= event.name %></td>       
                                                    <td><img src="<%= event.image %>" alt="<%= event.name %>" style="max-height: 50px;"></td>
                                                    </tr>
                                                <% }); %>
                                                <% } else { %>
                                                <tr>
                                                    <td colspan="3">No events available</td>
                                                </tr>
                                                <% } %>
                                            </tbody>
                                            </table>
                                        </div>
                                        </div>
                                        
                                        <div class="mt-4">
                                        <button type="submit" class="btn btn-primary me-2" id="saveEventsBtn">
                                            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                                            Save Changes
                                        </button>
                                        </div>
                                    </form>
                                    </div>
                                </div>
                                </div>
                            </div>          

                        <% } %>
                    </div>

                    <%- include('../../../../partials/footer') %>
                    <div class="content-backdrop fade"></div>
                </div>
            </div>
        </div>
        <div class="layout-overlay layout-menu-toggle"></div>
    </div>
</body>

<script>
$(document).ready(function() {
     // Banner image handling (keep this the same)
    $('#bannerImage').change(function() {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                $('#bannerImagePreview').attr('src', e.target.result);
                $('#bannerImageContainer').show();
                $('#removeBannerImageFlag').val('false');
            }
            reader.readAsDataURL(this.files[0]);
        }
    });

    /// Remove Banner
    $('#removeBannerImageBtn').click(function() {
        $('#bannerImage').val('');
        $('#bannerImagePreview').attr('src', '');
        $('#bannerImageContainer').hide();
        $('#removeBannerImageFlag').val('true');
    });

    // Form submission
    $('#pageForm').on('submit', function(e) {
        e.preventDefault();
        const btn = $('#savePageBtn');
        btn.prop('disabled', true);
        btn.find('.spinner-border').removeClass('d-none');

        const formData = new FormData(this);

        $.ajax({
        url: '/pages/<%= page?.pageType || req.params.pageType %>',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            Swal.fire({
                title: 'Success!',
                text: response.message,
                icon: 'success',
                confirmButtonText: 'OK'
            }).then(() => {
                window.location.reload();
            });
        },
        error: function(xhr) {
            Swal.fire({
                title: 'Error!',
                text: xhr.responseJSON?.message || 'Failed to save page',
                icon: 'error',
                confirmButtonText: 'OK'
            });
        },
        complete: function() {
            btn.prop('disabled', false);
            btn.find('.spinner-border').addClass('d-none');
        }
        });
    });

    /// propertyTypeForm
    $('#propertyTypeForm').on('submit', function(e) {
        e.preventDefault();
        const btn = $('#savePropertyTypeBtn');
        btn.prop('disabled', true);
        btn.find('.spinner-border').removeClass('d-none');

        const formData = {
            pageType: $(this).find('[name="pageType"]').val(),
            propertyTypesTitle: $(this).find('[name="propertyTypesTitle"]').val(),
            propertyTypes: $(this).find('[name="propertyTypes"]:checked').map(function() {
            return $(this).val();
            }).get()
        };

        // Validate at least 6 property types selected
        if (formData.propertyTypes.length !== 6) {
                Swal.fire({
                title: 'Error!',
                text: 'Please select exactly 6 property types',
                icon: 'error',
                confirmButtonText: 'OK'
            });
            btn.prop('disabled', false);
            btn.find('.spinner-border').addClass('d-none');
            return;
        }

        $.ajax({
            url: '/update-home-property-types',
            method: 'POST',
            data: formData,
            success: function(response) {
                Swal.fire({
                    title: 'Success!',
                    text: response.message,
                    icon: 'success',
                    confirmButtonText: 'OK'
                });
            },
            error: function(xhr) {
                Swal.fire({
                    title: 'Error!',
                    text: xhr.responseJSON?.message || 'Failed to save property types',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            },
            complete: function() {
                btn.prop('disabled', false);
                btn.find('.spinner-border').addClass('d-none');
            }
        });
    });

    // Services Form Submission
    $('#servicesForm').on('submit', function(e) {
        e.preventDefault();
        const btn = $('#saveServicesBtn');
        btn.prop('disabled', true);
        btn.find('.spinner-border').removeClass('d-none');

        const formData = {
            pageType: $(this).find('[name="pageType"]').val(),
            servicesTitle: $(this).find('[name="servicesTitle"]').val(),
            services: $(this).find('[name="services"]:checked').map(function() {
            return $(this).val();
            }).get()
        };

        if (formData.services.length !== 6) {
                Swal.fire({
                title: 'Error!',
                text: 'Please select exactly 6 services',
                icon: 'error',
                confirmButtonText: 'OK'
            });
            btn.prop('disabled', false);
            btn.find('.spinner-border').addClass('d-none');
            return;
        }

        $.ajax({
            url: '/update-home-services',
            method: 'POST',
            data: formData,
            success: function(response) {
            Swal.fire({
                title: 'Success!',
                text: response.message,
                icon: 'success',
                confirmButtonText: 'OK'
            });
            },
            error: function(xhr) {
            Swal.fire({
                title: 'Error!',
                text: xhr.responseJSON?.message || 'Failed to save services',
                icon: 'error',
                confirmButtonText: 'OK'
            });
            },
            complete: function() {
            btn.prop('disabled', false);
            btn.find('.spinner-border').addClass('d-none');
            }
        });
    });

    // Events Form Submission
    $('#eventsForm').on('submit', function(e) {
        e.preventDefault();
        const btn = $('#saveEventsBtn');
        btn.prop('disabled', true);
        btn.find('.spinner-border').removeClass('d-none');

        const formData = {
            pageType: $(this).find('[name="pageType"]').val(),
            eventsTitle: $(this).find('[name="eventsTitle"]').val(),
            events: $(this).find('[name="events"]:checked').map(function() {
            return $(this).val();
            }).get()
        };

        if (formData.events.length !== 6) {
                Swal.fire({
                title: 'Error!',
                text: 'Please select exactly 6 event categories',
                icon: 'error',
                confirmButtonText: 'OK'
            });
            btn.prop('disabled', false);
            btn.find('.spinner-border').addClass('d-none');
            return;
        }

        $.ajax({
            url: '/update-home-events',
            method: 'POST',
            data: formData,
            success: function(response) {
                Swal.fire({
                    title: 'Success!',
                    text: response.message,
                    icon: 'success',
                    confirmButtonText: 'OK'
                });
            },
            error: function(xhr) {
            Swal.fire({
                title: 'Error!',
                text: xhr.responseJSON?.message || 'Failed to save event categories',
                icon: 'error',
                confirmButtonText: 'OK'
            });
            },
            complete: function() {
            btn.prop('disabled', false);
            btn.find('.spinner-border').addClass('d-none');
            }
        });
    });

    // Image preview for all slider forms
    $(document).on('change', '.slider-image', function() {
        const preview = $(this).siblings('.slider-preview');
        if (this.files && this.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.attr('src', e.target.result).show();
        }
        reader.readAsDataURL(this.files[0]);
        }
    });

    // Remove slider button
    $(document).on('click', '.remove-slider-btn', function() {
        const form = $(this).closest('.slider-form');
        const sliderId = form.find('[name="sliderId"]').val();
        const pageType = form.find('[name="pageType"]').val();
        
        Swal.fire({
        title: 'Are you sure?',
        text: "You won't be able to revert this!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, remove it!'
        }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
            url: '/pages-update-slider',
            method: 'POST',
            data: {
                pageType,
                sliderId,
                action: 'remove'
            },
            success: function(response) {
                Swal.fire({
                title: 'Removed!',
                text: response.message,
                icon: 'success',
                confirmButtonText: 'OK'
                }).then(() => {
                window.location.reload();
                });
            },
            error: function(xhr) {
                Swal.fire({
                title: 'Error!',
                text: xhr.responseJSON?.message || 'Failed to remove slider',
                icon: 'error',
                confirmButtonText: 'OK'
                });
            }
            });
        }
        });
    });

    // Update slider form submission
    $(document).on('submit', '.slider-form:not(#addSliderForm)', function(e) {
        e.preventDefault();
        const form = $(this);
        const btn = form.find('[type="submit"]');
        btn.prop('disabled', true);
        btn.find('.spinner-border').removeClass('d-none');

        const formData = new FormData(this);

        $.ajax({
        url: '/pages-update-slider',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            Swal.fire({
            title: 'Success!',
            text: response.message,
            icon: 'success',
            confirmButtonText: 'OK'
            }).then(() => {
            window.location.reload();
            });
        },
        error: function(xhr) {
            Swal.fire({
            title: 'Error!',
            text: xhr.responseJSON?.message || 'Failed to update slider',
            icon: 'error',
            confirmButtonText: 'OK'
            });
        },
        complete: function() {
            btn.prop('disabled', false);
            btn.find('.spinner-border').addClass('d-none');
        }
        });
    });

    // Add new slider form submission
    $('#addSliderForm').on('submit', function(e) {
        e.preventDefault();
        const btn = $(this).find('[type="submit"]');
        btn.prop('disabled', true);
        btn.find('.spinner-border').removeClass('d-none');

        const formData = new FormData(this);

        $.ajax({
        url: '/pages-update-slider',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            Swal.fire({
            title: 'Success!',
            text: response.message,
            icon: 'success',
            confirmButtonText: 'OK'
            }).then(() => {
            window.location.reload();
            });
        },
        error: function(xhr) {
            Swal.fire({
            title: 'Error!',
            text: xhr.responseJSON?.message || 'Failed to add slider',
            icon: 'error',
            confirmButtonText: 'OK'
            });
        },
        complete: function() {
            btn.prop('disabled', false);
            btn.find('.spinner-border').addClass('d-none');
        }
        });
    });

});
</script>

